# Main entrypoint of the workflow. 
# Please follow the best practices: 
# https://snakemake.readthedocs.io/en/stable/snakefiles/best_practices.html,
# in particular regarding the standardized folder structure mentioned there. 

configfile: "config/config.yml"

SUBSETS = config["subset"]
BASELINE_DATE = config["pmc_baseline_date"]

checkpoint bulk_download_pmc_metadata:
    input:
        storage.ftp(
            expand(
                "ftp://ftp.ncbi.nlm.nih.gov/pub/pmc/oa_bulk/oa_noncomm/xml/oa_noncomm_xml.PMC"
                f"{{subset}}"
                "xxxxxx.baseline."
                f"{BASELINE_DATE}"
                ".tar.gz",
                subset=SUBSETS
            )
        )
    output:
        directory("resources/metadata")
    shell:
        "mkdir -p {output} && cp {input} {output}"

# checkpoint bulk_download_pmc_metadata:
#     input:
#         expand(
#                 "fakeresources/oa_noncomm_xml.PMC"
#                 f"{{subset}}"
#                 "xxxxxx.baseline."
#                 f"{BASELINE_DATE}"
#                 ".tar.gz",
#                 subset=SUBSETS
#         )
#     output:
#         directory("resources/metadata")
#     shell:
#         "mkdir -p {output} && tar -xzvf {input} -C {output}"

# def expand_metadata_files(wildcards):
#     file_dir = checkpoints.bulk_download_pmc_metadata.get(**wildcards).output[0]
#     file_names = glob_wildcards(
#         os.path.join(file_dir, f"oa_noncomm_xml.PMC{{file_name}}xxxxxx.baseline.{BASELINE_DATE}.tar.gz")
#     ).file_name
#     return expand(f"resources/metadata/oa_noncomm_xml.PMC{{subset}}xxxxxx.baseline.{BASELINE_DATE}.tar.gz", subset=file_names)
#
# rule fake:
#     input:
#         expand_metadata_files
#     output:
#         "resources/{subset}.json"
#     script:
#         "scripts/fakecopy.py"
#
# rule all:
#     default_target: True
#     input:
#         expand("resources/{subset}.json", subset=config["subset"])

rule clean:
    threads: 1
    shell:
        "rm -rf resources/ results/ .cache/ .conda/ .snakemake/ logs/"  # Keeping extracted files
